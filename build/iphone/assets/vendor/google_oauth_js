var GoogleAuth=function(e){function t(){var e={};return e.accessToken=Ti.App.Properties.getString(c.propertyName+".accessToken"),e.refreshToken=Ti.App.Properties.getString(c.propertyName+".refreshToken"),e.tokenType=Ti.App.Properties.getString(c.propertyName+".tokenType"),e.expiresIn=Ti.App.Properties.getString(c.propertyName+".expiresIn"),e}function i(e){e=e?e:function(){},u=Ti.UI.createWindow({backgroundColor:"white",barColor:c.winColor,modal:!0,title:c.winTitle});var t=Ti.UI.createActivityIndicator({zIndex:1,height:50,width:50,hide:!0,style:Ti.UI.iPhone.ActivityIndicatorStyle.DARK}),i=Ti.UI.createButton({title:c.closeTitle});u.add(t),u.rightNavButton=i,i.addEventListener("click",function(){u.close()});var o=a(),r=Ti.UI.createWebView({width:"100%",height:"100%",url:o});u.add(r);var s=0;r.addEventListener("load",function(){s++;var i=r.evalJS('document.getElementById("access_denied").value;');""!=i&&(p.debug("GoogleAuth: Access denied!"),Ti.App.Properties.setString(c.propertyName+".accessToken",""),Ti.App.Properties.setString(c.propertyName+".refreshToken",""),Ti.App.Properties.setString(c.propertyName+".tokenType",""),Ti.App.Properties.setString(c.propertyName+".expiresIn",0),T.accessToken=null,T.refreshToken=null,T.tokenType=null,T.expiresIn=0,u.close());var o=r.evalJS('document.getElementById("code").value;');""!=o&&(p.debug("GoogleAuth: Access granted!"),r.hide(),t.show(),n(o,e)),s>10&&(p.debug("GoogleAuth: To many redirects..."),u.close())}),u.open()}function o(e){if(e=e?e:function(){},p.debug("GoogleAuth: User logging out..."),s()){var t=Ti.UI.createWindow({backgroundColor:"white",barColor:c.winColor,modal:!0,title:c.winTitle}),i=Ti.UI.createButton({title:c.closeTitle}),o=Ti.UI.createActivityIndicator({zIndex:1,height:50,width:50,style:Ti.UI.iPhone.ActivityIndicatorStyle.DARK});t.rightNavButton=i,i.addEventListener("click",function(){t.close()});var r=Ti.UI.createWebView({width:"100%",height:"100%",url:"https://accounts.google.com/Logout"});t.add(o),t.add(r),r.addEventListener("load",function(){setTimeout(function(){t.close(),e()},500),Ti.App.Properties.setString(c.propertyName+".accessToken",""),Ti.App.Properties.setString(c.propertyName+".refreshToken",""),Ti.App.Properties.setString(c.propertyName+".tokenType",""),Ti.App.Properties.setString(c.propertyName+".expiresIn",0),T.accessToken=null,T.refreshToken=null,T.tokenType=null,T.expiresIn=0}),t.open()}}function r(e,t){p.info("GoogleAuth: Access code not valid. Refreshing..."),e=e?e:function(){},t=t?t:function(){};var i=Ti.Network.createHTTPClient({onload:function(){var t=JSON.parse(this.responseText);t.expires_in=1e3*parseFloat(t.expires_in,10)+(new Date).getTime(),Ti.App.Properties.setString(c.propertyName+".accessToken",t.access_token),Ti.App.Properties.setString(c.propertyName+".tokenType",t.token_type),Ti.App.Properties.setString(c.propertyName+".expiresIn",t.expires_in),T.accessToken=t.access_token,T.tokenType=t.token_type,T.expiresIn=t.expires_in,p.debug(T),e()},onerror:function(e){p.info(e.error),p.info(e.responseText),t(),Ti.UI.createAlertDialog({title:"Error",message:c.errorText}),t()},timeout:5e3});i.open("POST",c.url),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded");var o={client_id:c.clientId,client_secret:c.clientSecret,refresh_token:T.refreshToken,grant_type:"refresh_token"};i.send(o)}function n(e,t){t=t?t:function(){};var i=Ti.Network.createHTTPClient({onload:function(){var e=JSON.parse(this.responseText);p.info(e.expires_in),e.expires_in=1e3*parseFloat(e.expires_in,10)+(new Date).getTime(),p.info(e.expires_in),Ti.App.Properties.setString(c.propertyName+".accessToken",e.access_token),Ti.App.Properties.setString(c.propertyName+".refreshToken",e.refresh_token),Ti.App.Properties.setString(c.propertyName+".tokenType",e.token_type),Ti.App.Properties.setString(c.propertyName+".expiresIn",e.expires_in),T.accessToken=e.access_token,T.refreshToken=e.refresh_token,T.tokenType=e.token_type,T.expiresIn=e.expires_in,p.debug(T),u.close(),t()},onerror:function(){Ti.UI.createAlertDialog({title:"Error",message:c.errorText}),u.close()},timeout:5e3});i.open("POST","https://accounts.google.com/o/oauth2/token"),i.setRequestHeader("Content-Type","application/x-www-form-urlencoded");var o={code:e,client_id:c.clientId,client_secret:c.clientSecret,redirect_uri:"urn:ietf:wg:oauth:2.0:oob",grant_type:"authorization_code"};i.send(o)}function a(){for(var e=[],t=0;c.scope.length>t;t++)e[t]=encodeURIComponent(c.scope[t]);var i=c.url+"?"+"approval_prompt=force&scope="+e.join("+")+"&"+"redirect_uri=urn:ietf:wg:oauth:2.0:oob"+"&"+"response_type=code"+"&"+"client_id="+c.clientId+"&"+"btmpl=mobile";return p.debug(i),i}function s(e,i){return e=e?e:function(){},i=i?i:function(){},T=t(),p.debug("Properties: "+JSON.stringify(T)),null!=T.accessToken&&""!=T.accessToken?(T.expiresIn<(new Date).getTime()?r(e,i):e(),!0):(i(),!1)}function l(){return T.accessToken}var d="0.3.2";e=e?e:{};var c={clientId:e.clientId?e.clientId:null,clientSecret:e.clientSecret?e.clientSecret:null,propertyName:e.propertyName?e.propertyName:"googleToken",url:"https://accounts.google.com/o/oauth2/auth",scope:e.scope?e.scope:["https://www.googleapis.com/auth/tasks"],closeTitle:e.closeTitle?e.closeTitle:"Close",winTitle:e.winTitle?e.winTitle:"Google Account",errorText:e.errorText?e.errorText:"Can not authorize user!",winColor:e.winColor?e.winColor:"#000",quiet:e.quiet===void 0?!0:e.quiet},p=function(){};p.error=function(e){c.quiet||Ti.API.error(""+e)},p.info=function(e){c.quiet||Ti.API.info(e)},p.debug=function(e){c.quiet||Ti.API.debug(""+e)},p.trace=function(e){c.quiet||Ti.API.trace(""+e)},p.info("-------------------------------------"),p.info("| Google Account Authentification   |"),p.info("| Titanium Module (v.:"+d+")        |"),p.info("| by Miroslav Magda                 |"),p.info("-------------------------------------");var u,T={};T.accessToken=null,T.refreshToken=null,T.tokenType=null,T.expiresIn=0;var g={};return g=t(),g.expiresIn>=(new Date).getTime()&&(p.info("GoogleAuth: Access code valid"),T=g),{isAuthorized:s,deAuthorize:o,getAccessToken:l,refreshToken:r,authorize:i,version:d}};module.exports=GoogleAuth;